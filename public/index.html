<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>AirParty 3D – Runway</title>
<style>
  :root { --bg:#0b0f1a; --panel:#0e1530; --ink:#e8eefc; --brand:#7ab8ff; }
  html,body{margin:0;height:100%;background:var(--bg);color:var(--ink);font-family:system-ui,Segoe UI,Roboto,Helvetica,Arial}
  .wrap{display:grid;grid-template-rows:auto 1fr;height:100%}
  header{display:flex;align-items:center;gap:8px;padding:10px 12px;background:linear-gradient(180deg,#101842,#0a1026);border-bottom:1px solid rgba(150,180,255,.2)}
  header .right{margin-left:auto;display:flex;gap:8px;align-items:center}
  .btn{border:1px solid rgba(150,180,255,.3);background:#13204a;color:var(--ink);padding:7px 10px;border-radius:10px;cursor:pointer}
  .btn.primary{background:var(--brand);color:#061022;border:none;font-weight:700}
  main{display:grid;grid-template-columns:320px 1fr 320px;gap:12px;padding:12px}
  .panel{background:var(--panel);border:1px solid rgba(150,180,255,.18);border-radius:12px;overflow:hidden;display:flex;flex-direction:column;box-shadow:0 10px 30px rgba(0,0,0,.25)}
  .panel header{padding:8px 10px;background:#0b1230;border-bottom:1px solid rgba(150,180,255,.18);font-weight:700}
  .panel .body{padding:10px;flex:1;overflow:auto}
  .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
  .input{background:#0d1636;border:1px solid rgba(150,180,255,.25);color:var(--ink);border-radius:10px;padding:8px 10px}
  .list{list-style:none;margin:0;padding:0;display:flex;flex-direction:column;gap:6px}
  .chip{padding:4px 8px;background:#0c1228;border:1px solid rgba(150,180,255,.2);border-radius:999px}
  #viewport{position:fixed;inset:0;display:none;background:#000}
  #hud{position:fixed;left:12px;bottom:12px;display:none;background:rgba(10,16,38,.6);border:1px solid rgba(150,180,255,.25);padding:8px 10px;border-radius:12px;font-size:13px}
  #fps{position:fixed;right:12px;bottom:12px;display:none;background:rgba(10,16,38,.6);border:1px solid rgba(150,180,255,.25);padding:6px 8px;border-radius:8px;font-size:12px}
</style>
</head>
<body>
<div class="wrap" id="lobbyScreen">
  <header>
    <div>✈️ AirParty</div>
    <div class="right">
      <span>Room: <strong id="roomId">—</strong></span>
      <button id="btnStart" class="btn primary" style="display:none;">Start (host)</button>
    </div>
  </header>
  <main>
    <section class="panel">
      <header>Lobby</header>
      <div class="body">
        <div class="row">
          <input id="inpName" class="input" placeholder="Your name" style="flex:1"/>
          <input id="inpColor" type="color" class="input" value="#ffb347"/>
          <button id="btnSet" class="btn">Set</button>
          <label class="chip"><input type="checkbox" id="chkReady"> Ready</label>
        </div>
        <hr style="opacity:.25;margin:10px 0">
        <div><strong>Pilots</strong></div>
        <ul id="players" class="list"></ul>
        <hr style="opacity:.25;margin:10px 0">
        <div><strong>Chat</strong></div>
        <div id="chat" style="height:160px;overflow:auto;background:#0b1430;border:1px solid rgba(150,180,255,.2);border-radius:10px;padding:8px;"></div>
        <div class="row" style="margin-top:6px;">
          <input id="inpChat" class="input" placeholder="Message…" style="flex:1;"/>
          <button id="btnChat" class="btn">Send</button>
        </div>
      </div>
    </section>

    <section class="panel" style="grid-template-rows:auto 1fr">
      <header>Preview</header>
      <div class="body">
        <p>Controls:</p>
        <ul>
          <li>Arrow Up/Down — pitch</li>
          <li>Arrow Left/Right — yaw (auto-level roll)</li>
          <li>Space — boost</li>
        </ul>
        <p>Spawned side-by-side on a wide runway.</p>
      </div>
    </section>

    <section class="panel">
      <header>Tips</header>
      <div class="body">
        <p>Low-poly & capped DPR for smooth FPS. Snapshots ~12 Hz + client interpolation.</p>
      </div>
    </section>
  </main>
</div>

<div id="viewport"></div>
<div id="hud">SPD <span id="spd">0</span> | ALT <span id="alt">0</span></div>
<div id="fps">FPS —</div>

<script src="/socket.io/socket.io.js"></script>
<script src="https://unpkg.com/three@0.160.0/build/three.min.js"></script>
<script>
(() => {
  // ===== SOCKET / LOBBY =====
  const url = new URL(location.href);
  const room = url.searchParams.get("room") || "airfield";
  if(!url.searchParams.get("room")){ url.searchParams.set("room", room); history.replaceState(null,"",url.toString()); }
  const socket = io({ query:{ room }, transports:["websocket"], upgrade:true });

  let me={id:null,hostId:null};
  const roomIdEl=document.getElementById("roomId");
  const btnStart=document.getElementById("btnStart");
  const playersEl=document.getElementById("players");
  const inpName=document.getElementById("inpName");
  const inpColor=document.getElementById("inpColor");
  const btnSet=document.getElementById("btnSet");
  const chkReady=document.getElementById("chkReady");
  const chatEl=document.getElementById("chat");
  const inpChat=document.getElementById("inpChat");
  const btnChat=document.getElementById("btnChat");
  roomIdEl.textContent=room;

  btnSet.onclick=()=>socket.emit("player:set",{name:(inpName.value||"").slice(0,24),color:inpColor.value});
  chkReady.onchange=()=>socket.emit("player:ready",{ready:chkReady.checked});
  btnChat.onclick=()=>{const text=(inpChat.value||"").trim(); if(!text) return; socket.emit("chat:send",{text}); inpChat.value="";};
  inpChat.addEventListener("keydown",e=>{if(e.key==="Enter") btnChat.click();});
  btnStart.onclick=()=>socket.emit("game:start");

  socket.on("room:joined",({playerId,hostId})=>{
    me.id=playerId; me.hostId=hostId;            // keep hostId immediately
    inpName.value="Pilot "+playerId.slice(0,4);
    // show start if we already know we're the host & still in lobby (until room:state says otherwise)
    btnStart.style.display = (me.id===me.hostId) ? "" : "none";
  });

  socket.on("room:state",(p)=>{
    // if hostId not present yet, fall back to remembered one
    const host = p.hostId || me.hostId;
    playersEl.innerHTML="";
    (p.players||[]).forEach(pl=>{
      const li=document.createElement("li");
      li.innerHTML=`<span class="chip" style="background:${pl.color}"></span> <strong>${esc(pl.name)}</strong> ${pl.id===host?'<span class="chip">Host</span>':''} ${pl.ready?'<span class="chip">Ready</span>':''}`;
      playersEl.appendChild(li);
    });
    // ✅ keep the Start button visible for the host while in lobby
    btnStart.style.display = (p.state==="lobby" && me.id===host) ? "" : "none";
  });

  socket.on("chat:new",({name,text})=>{
    const div=document.createElement("div"); div.innerHTML=`<strong>${esc(name)}:</strong> ${esc(text)}`;
    chatEl.appendChild(div); chatEl.scrollTop=chatEl.scrollHeight;
  });

  socket.on("game:start",()=>enterWorld());
  const esc=s=>(s+"").replace(/[&<>"']/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));

  // ===== 3D WORLD =====
  let renderer, scene, camera, clock, DPR=Math.min(1.5,devicePixelRatio||1);
  const viewport=document.getElementById("viewport");
  const hud=document.getElementById("hud");
  const fpsEl=document.getElementById("fps");
  const spdEl=document.getElementById("spd");
  const altEl=document.getElementById("alt");

  let local={obj:null,color:"#ffb347",speed:25};
  const peers=new Map(); // id -> {obj,last}
  const keys={ArrowUp:false,ArrowDown:false,ArrowLeft:false,ArrowRight:false,Space:false};
  addEventListener("keydown",e=>{if(e.repeat) return; if(e.key in keys){ keys[e.key]=true; e.preventDefault(); }});
  addEventListener("keyup",e=>{if(e.key in keys){ keys[e.key]=false; e.preventDefault(); }});

  function enterWorld(){
    document.getElementById("lobbyScreen").style.display="none";
    viewport.style.display="block"; hud.style.display="block"; fpsEl.style.display="block";

    renderer=new THREE.WebGLRenderer({antialias:false,powerPreference:"high-performance"});
    renderer.setPixelRatio(DPR); renderer.setSize(innerWidth,innerHeight);
    viewport.appendChild(renderer.domElement);

    scene=new THREE.Scene();
    scene.background=new THREE.Color(0x87b5f5);
    scene.fog=new THREE.FogExp2(0x87b5f5,0.0009);

    camera=new THREE.PerspectiveCamera(70,innerWidth/innerHeight,0.1,8000);

    scene.add(new THREE.AmbientLight(0xffffff,0.7));
    const sun=new THREE.DirectionalLight(0xffffff,0.8); sun.position.set(100,200,50); scene.add(sun);

    buildRunwayScene(scene);

    local.color=inpColor.value||"#ffb347";
    local.obj=makeCubePlane(local.color,0.6);  // fixed geometry (wings horizontal)
    scene.add(local.obj);

    // Chase cam behind & a bit above
    const boom=new THREE.Object3D(); local.obj.add(boom); boom.add(camera);
    camera.position.set(-12, 3, 0); camera.lookAt(new THREE.Vector3(10,0,0));

    clock=new THREE.Clock();

    socket.on("state:snapshot",(arr)=>{
      const ids=new Set(arr.map(a=>a.id));
      for(const a of arr){
        if(a.id===me.id){ local.obj.position.set(a.x,a.y,a.z); local.obj.quaternion.set(a.qx,a.qy,a.qz,a.qw); continue; }
        let o=peers.get(a.id);
        if(!o){ const obj=makeCubePlane(a.color||"#7ab8ff",0.6); obj.position.set(a.x,a.y,a.z); obj.quaternion.set(a.qx,a.qy,a.qz,a.qw); scene.add(obj); o={obj,last:a}; peers.set(a.id,o); }
        else { o.last=a; }
      }
      for(const [id,o] of peers){ if(!ids.has(id)){ scene.remove(o.obj); peers.delete(id); } }
    });

    tick();
  }

  // ✅ fixed: wingspan along Z (left-right); forward is +X
  function makeCubePlane(color="#ffb347", scale=1){
    const g=new THREE.Object3D();
    const mat=new THREE.MeshStandardMaterial({color,metalness:0.05,roughness:0.85});

    // body (forward along +X)
    const body=new THREE.Mesh(new THREE.BoxGeometry(2.2*scale,0.7*scale,0.7*scale),mat);
    g.add(body);

    // wings: long on Z so they are horizontal
    const wings=new THREE.Mesh(new THREE.BoxGeometry(0.25*scale,0.12*scale,4.6*scale),mat);
    g.add(wings);

    // tailplane: also horizontal on Z
    const tail=new THREE.Mesh(new THREE.BoxGeometry(0.2*scale,0.1*scale,1.4*scale),mat);
    tail.position.set(-1.3*scale,0.35*scale,0); g.add(tail);

    // actuators on wingtips and tail
    const white=new THREE.MeshStandardMaterial({color:"#fff",roughness:0.6});
    const a1=new THREE.Mesh(new THREE.BoxGeometry(0.18*scale,0.18*scale,0.18*scale),white); a1.position.set(0,0, 2.5*scale); g.add(a1);
    const a2=a1.clone(); a2.position.z*=-1; g.add(a2);
    const a3=a1.clone(); a3.position.set(-1.9*scale,0.7*scale,0); g.add(a3);

    // prop cube in front
    const prop=new THREE.Mesh(new THREE.BoxGeometry(0.12*scale,0.9*scale,0.12*scale), new THREE.MeshStandardMaterial({color:"#eee"}));
    prop.position.set(1.3*scale,0,0); g.add(prop); g.userData.prop=prop;

    return g;
  }

  function buildRunwayScene(scene){
    const ground=new THREE.Mesh(new THREE.PlaneGeometry(6000,3000), new THREE.MeshPhongMaterial({color:0x2f7d32}));
    ground.rotation.x=-Math.PI/2; ground.position.y=0; scene.add(ground);

    const runway=new THREE.Mesh(new THREE.PlaneGeometry(4000,400), new THREE.MeshPhongMaterial({color:0x3b3b3b}));
    runway.rotation.x=-Math.PI/2; runway.position.set(0,0.02,0); scene.add(runway);

    const dashMat=new THREE.MeshBasicMaterial({color:0xffffff});
    for(let x=-1800; x<=1800; x+=120){
      const dash=new THREE.Mesh(new THREE.PlaneGeometry(40,4), dashMat);
      dash.rotation.x=-Math.PI/2; dash.position.set(x,0.03,0);
      scene.add(dash);
    }
  }

  // ===== Flight model (fixed axes) =====
  // Pitch = around Z ; Yaw = around Y ; Roll auto-levels around X
  let lastSend=0;
  function simulateLocal(dt){
    const obj=local.obj;

    const pitchIn=(keys.ArrowUp? 1:0) + (keys.ArrowDown? -1:0);
    const yawIn  =(keys.ArrowRight?1:0) + (keys.ArrowLeft? -1:0);
    const boost  = keys.Space?1:0;

    // throttle
    const accel = (boost?28:0) - 6*(boost?0.2:1);
    local.speed = THREE.MathUtils.clamp(local.speed + accel*dt, 10, 140);

    // orientations (correct axes)
    obj.rotateZ(pitchIn * 0.9 * dt);  // pitch
    obj.rotateY(yawIn   * 1.2 * dt);  // yaw

    // auto-level roll (X toward 0)
    const e = new THREE.Euler().setFromQuaternion(obj.quaternion, "XYZ");
    obj.rotateX(-e.x * 0.85 * dt);

    // move along forward (+X in local space)
    const f = new THREE.Vector3(1,0,0).applyQuaternion(obj.quaternion);
    obj.position.addScaledVector(f, local.speed * dt);

    // ground: only clamp if we *touch* it
    if (obj.position.y < 1.8) obj.position.y = 1.8;

    // prop spin
    const prop=obj.userData.prop; if(prop) prop.rotation.x += dt*35;

    // HUD
    spdEl.textContent = local.speed.toFixed(0);
    altEl.textContent = (obj.position.y|0);

    // send ~12 Hz
    const now=performance.now();
    if(now-lastSend>80){
      lastSend=now; const q=obj.quaternion, p=obj.position;
      socket.emit("state:update",{ x:+p.x.toFixed(2), y:+p.y.toFixed(2), z:+p.z.toFixed(2),
        qx:+q.x.toFixed(4), qy:+q.y.toFixed(4), qz:+q.z.toFixed(4), qw:+q.w.toFixed(4),
        s:+local.speed.toFixed(1) });
    }
  }

  // Peers (interpolate)
  const tmpQ=new THREE.Quaternion(), curQ=new THREE.Quaternion();
  function simulatePeers(dt){
    for(const o of peers.values()){
      if(!o.last) continue;
      const p=o.obj.position;
      p.x += (o.last.x - p.x) * Math.min(1, dt*6);
      p.y += (o.last.y - p.y) * Math.min(1, dt*6);
      p.z += (o.last.z - p.z) * Math.min(1, dt*6);
      tmpQ.set(o.last.qx,o.last.qy,o.last.qz,o.last.qw).normalize();
      curQ.copy(o.obj.quaternion).slerp(tmpQ, Math.min(1, dt*6));
      o.obj.quaternion.copy(curQ);
      const prop=o.obj.userData.prop; if(prop) prop.rotation.x += dt*35;
    }
  }

  // Loop + dynamic res
  let renderer,scene,camera,clock; // (for lints)
  let frameCount=0, acc=0, fps=60, DPR=Math.min(1.5,devicePixelRatio||1);
  function tick(){
    const dt=Math.min(0.05,(clock?clock.getDelta():0.016));
    acc+=dt; frameCount++; if(acc>=1){ fps=frameCount; frameCount=0; acc=0; document.getElementById("fps").textContent=`FPS ${fps}`; }
    if(fps<45 && DPR>1){ DPR=Math.max(1,DPR-0.05); renderer.setPixelRatio(DPR); }
    else if(fps>70 && DPR<(devicePixelRatio||1)){ DPR=Math.min(devicePixelRatio||1, DPR+0.05); renderer.setPixelRatio(DPR); }

    if(local.obj){ simulateLocal(dt); simulatePeers(dt); }
    renderer.render(scene,camera);
    requestAnimationFrame(tick);
  }

  // init renderer/scene/camera/clock in enterWorld
  let _init=false;
  function setGlobals(r,s,c,k){ renderer=r; scene=s; camera=c; clock=k; }

  // override enterWorld to set globals after creation
  const _enterWorld = enterWorld;
  enterWorld = function(){
    _enterWorld();
    setGlobals(renderer,scene,camera,clock);
  }

  addEventListener("resize",()=>{
    if(!renderer) return; renderer.setSize(innerWidth,innerHeight);
    if(camera){ camera.aspect=innerWidth/innerHeight; camera.updateProjectionMatrix(); }
  });
})();
</script>
</body>
</html>
