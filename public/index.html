<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>MiniGolf Party</title>
<style>
  :root { --bg:#0b0f1a; --panel:#101935; --panel2:#0d1430; --ink:#e8eefc; --brand:#7ab8ff; --accent:#56ffa9; --warn:#ffd166; }
  html,body{margin:0;height:100%;background:var(--bg);color:var(--ink);font-family:system-ui,Segoe UI,Roboto,Helvetica,Arial;}
  .wrap{display:grid;grid-template-rows:auto 1fr; height:100%;}
  header{display:flex;gap:8px;align-items:center;padding:10px 12px;background:linear-gradient(180deg,#111a44,#0b1128);border-bottom:1px solid rgba(150,180,255,.2)}
  header .title{font-weight:800}
  header .right{margin-left:auto;display:flex;gap:8px;align-items:center}
  .btn{border:1px solid rgba(150,180,255,.3);background:#13204a;color:var(--ink);padding:7px 10px;border-radius:10px;cursor:pointer}
  .btn.primary{background:var(--brand);color:#061022;border:none;font-weight:700}
  main{display:grid;grid-template-columns:320px 1fr 320px;gap:12px;padding:12px}
  .panel{background:var(--panel);border:1px solid rgba(150,180,255,.18);border-radius:12px;overflow:hidden;display:flex;flex-direction:column;box-shadow:0 10px 30px rgba(0,0,0,.25)}
  .panel header{padding:8px 10px;background:var(--panel2);border-bottom:1px solid rgba(150,180,255,.18);font-weight:700}
  .panel .body{padding:10px;flex:1;overflow:auto}
  .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
  .input{background:#0d1636;border:1px solid rgba(150,180,255,.25);color:var(--ink);border-radius:10px;padding:8px 10px}
  .list{list-style:none;padding:0;margin:0;display:flex;flex-direction:column;gap:6px}
  .chip{padding:4px 8px;background:#0c1228;border:1px solid rgba(150,180,255,.2);border-radius:999px}
  .ready{color:#5fff87}
  #course{background:#071225;border-radius:12px;border:1px solid rgba(150,180,255,.2);display:block;width:100%;height:100%}
  .small{opacity:.85;font-size:12px}
  .avatarOpt{cursor:pointer;padding:6px 8px;border:1px solid transparent;border-radius:10px}
  .avatarOpt.active{border-color:var(--brand);background:#0d1a44}
  .putter{width:20px;height:20px;border-radius:4px;border:2px solid rgba(255,255,255,.5);cursor:pointer}
  .putter.active{outline:2px solid var(--brand)}
  .score{display:grid;grid-template-columns:1fr auto;gap:6px}
  .score .me{color:#ffd166}
  .toast{position:fixed;left:50%;top:16px;transform:translateX(-50%);background:#13204a;border:1px solid rgba(150,180,255,.3);color:var(--ink);padding:8px 12px;border-radius:10px;display:none}
</style>
</head>
<body>
<div class="wrap">
<header>
  <div class="title">‚õ≥Ô∏è MiniGolf Party</div>
  <div id="holeInfo">Hole ‚Äî / Par ‚Äî</div>
  <div class="right">
    <span>Room: <strong id="roomId">‚Äî</strong></span>
    <button id="btnSound" class="btn">üîà Sound Off</button>
    <button id="btnStart" class="btn primary">Start (host)</button>
  </div>
</header>
<main>
  <!-- Left: Lobby -->
  <section class="panel">
    <header>Lobby</header>
    <div class="body" id="lobbyBody">
      <div class="row">
        <input id="inpName" class="input" placeholder="Your name" style="flex:1;"/>
        <button id="btnSet" class="btn">Set</button>
      </div>
      <div style="margin-top:8px;"><strong>Choose Avatar</strong></div>
      <div id="avatars" class="row" style="margin-top:4px;"></div>
      <div style="margin-top:8px;"><strong>Choose Putter</strong></div>
      <div id="putters" class="row" style="margin-top:4px;"></div>

      <div class="row" style="margin-top:10px;">
        <label class="chip"><input type="checkbox" id="chkReady"> Ready</label>
      </div>

      <hr style="opacity:.2;margin:12px 0">
      <div><strong>Players</strong></div>
      <ul id="players" class="list"></ul>

      <hr style="opacity:.2;margin:12px 0">
      <div><strong>Chat</strong></div>
      <div id="chat" style="height:160px;overflow:auto;background:#0b1430;border:1px solid rgba(150,180,255,.2);border-radius:10px;padding:8px;"></div>
      <div class="row" style="margin-top:6px;">
        <input id="inpChat" class="input" placeholder="Message‚Ä¶" style="flex:1;"/>
        <button id="btnChat" class="btn">Send</button>
      </div>
    </div>
  </section>

  <!-- Center: Game -->
  <section class="panel" style="grid-template-rows:auto 1fr">
    <header id="turnHeader">Waiting‚Ä¶</header>
    <div class="body" style="padding:0;display:grid;grid-template-rows:1fr 44px">
      <canvas id="course"></canvas>
      <div class="row" style="padding:6px 8px;background:#0d1430;border-top:1px solid rgba(150,180,255,.2)">
        <div class="chip small" id="powerLabel">Power: 0%</div>
        <div class="chip small">Drag from the ball to aim</div>
      </div>
    </div>
  </section>

  <!-- Right: Scoreboard -->
  <section class="panel">
    <header>Scoreboard</header>
    <div class="body">
      <div id="miniScore" class="score"></div>
      <hr style="opacity:.2;margin:10px 0">
      <div id="tips" class="small">Tip: Aim by dragging from your ball. Release to putt. Lowest strokes wins!</div>
    </div>
  </section>
</main>
</div>

<div class="toast" id="toast">Toast</div>

<script src="/socket.io/socket.io.js"></script>
<script>
(() => {
  // ----- ROOM / SOCKET -----
  const url = new URL(location.href);
  const room = url.searchParams.get("room") || "clubhouse";
  if (!url.searchParams.get("room")) {
    url.searchParams.set("room", room);
    history.replaceState(null, "", url.toString());
  }
  const socket = io({ query: { room }, transports: ["websocket"], upgrade: true });

  // ----- SIMPLE AUDIO (WebAudio) -----
  let ac=null, sfxOn=false;
  const btnSound = document.getElementById("btnSound");
  btnSound.onclick = () => { sfxOn = !sfxOn; if(sfxOn && !ac) ac = new (window.AudioContext||window.webkitAudioContext)(); btnSound.textContent = sfxOn ? "üîä Sound On" : "üîà Sound Off"; };
  function blip(freq=880, dur=0.07, type='square', gain=0.04){
    if(!sfxOn||!ac) return;
    const o=ac.createOscillator(), g=ac.createGain();
    o.type=type; o.frequency.value=freq; o.connect(g); g.connect(ac.destination);
    const t=ac.currentTime; g.gain.setValueAtTime(0,t); g.gain.linearRampToValueAtTime(gain,t+0.01); g.gain.exponentialRampToValueAtTime(0.0001,t+dur);
    o.start(t); o.stop(t+dur+0.05);
  }
  const sfx = {
    start:()=>{ blip(660,0.12,'square',0.05); setTimeout(()=>blip(990,0.10,'square',0.05),90); },
    hit:(p)=>{ blip(200+400*p,0.06,'triangle',0.05); },
    bonk:()=> blip(300,0.08,'sawtooth',0.04),
    cup:()=>{ blip(800,0.08,'triangle',0.05); setTimeout(()=>blip(1200,0.1,'triangle',0.05),70); },
    limit:()=> blip(180,0.25,'square',0.05),
    turn:()=> blip(520,0.08,'square',0.04)
  };
  // looped 8-bit-ish background
  let musicTimer=null;
  function musicStart(){
    if(!sfxOn) return;
    if(!ac) ac = new (window.AudioContext||window.webkitAudioContext)();
    const seq = [330,0,392,0,494,0,392,0,  330,0,392,0,523,0,494,0]; // tiny loop
    let i=0;
    musicTimer = setInterval(()=>{ const f=seq[i%seq.length]; if(f) blip(f,0.12,'square',0.02); i++; }, 220);
  }
  function musicStop(){ if(musicTimer){ clearInterval(musicTimer); musicTimer=null; } }

  // ----- STATE -----
  let me={id:null, hostId:null};
  let players=[]; let state="lobby"; let holeIndex=0; let turnPlayerId=null;
  let hole=null;

  // ----- UI REFS -----
  const roomIdEl = document.getElementById("roomId"); roomIdEl.textContent = room;
  const btnStart = document.getElementById("btnStart");
  const inpName = document.getElementById("inpName");
  const btnSet = document.getElementById("btnSet");
  const chkReady = document.getElementById("chkReady");
  const playersEl = document.getElementById("players");
  const chatEl = document.getElementById("chat");
  const inpChat = document.getElementById("inpChat");
  const btnChat = document.getElementById("btnChat");
  const holeInfo = document.getElementById("holeInfo");
  const turnHeader = document.getElementById("turnHeader");
  const miniScore = document.getElementById("miniScore");
  const toast = document.getElementById("toast");

  // Avatar & putter selectors
  const avatars = ["üê∏","üêº","ü¶ä","üêµ","üêπ","üê®","üêî","üêô","ü¶Ñ","ü§ñ","üëæ","üêØ"];
  const putterColors = ["#ff6b6b","#ffd166","#4dd599","#6c77ff","#ff8ccf","#a0f","#0ff","#0fa05a"];
  const avatarsEl = document.getElementById("avatars");
  const puttersEl = document.getElementById("putters");
  let selAvatar = avatars[0], selPutter = putterColors[0];

  avatars.forEach(av=>{
    const b=document.createElement("div"); b.className="avatarOpt"; b.textContent=av;
    b.onclick=()=>{ selAvatar=av; updateSelectors(); sendProfile(); };
    avatarsEl.appendChild(b);
  });
  putterColors.forEach(c=>{
    const d=document.createElement("div"); d.className="putter"; d.style.background=c;
    d.onclick=()=>{ selPutter=c; updateSelectors(); sendProfile(); };
    puttersEl.appendChild(d);
  });
  function updateSelectors(){
    [...avatarsEl.children].forEach(n=>n.classList.toggle("active", n.textContent===selAvatar));
    [...puttersEl.children].forEach(n=>n.classList.toggle("active", n.style.backgroundColor===hexToCss(selPutter)));
  }
  function hexToCss(h){ const t=document.createElement('div'); t.style.color=h; document.body.appendChild(t); const c=getComputedStyle(t).color; t.remove(); return c; }
  updateSelectors();

  btnSet.onclick = () => sendProfile();
  function sendProfile(){
    const name = (inpName.value||"").trim().slice(0,24) || inpName.placeholder || "Player";
    socket.emit("player:set", { name, avatar: selAvatar, putter: selPutter });
  }
  chkReady.onchange = ()=> socket.emit("player:ready", { ready: chkReady.checked });
  btnStart.onclick = ()=> socket.emit("game:start");

  btnChat.onclick = ()=>{ const text=(inpChat.value||"").trim(); if(!text) return; socket.emit("chat:send",{text}); inpChat.value=""; };
  inpChat.addEventListener("keydown", e=>{ if(e.key==="Enter") btnChat.click(); });

  // ----- CANVAS / GAME VIEW -----
  const canvas = document.getElementById("course");
  const ctx = canvas.getContext("2d");
  function resize(){
    canvas.width = canvas.clientWidth * devicePixelRatio;
    canvas.height= canvas.clientHeight * devicePixelRatio;
    ctx.setTransform(devicePixelRatio,0,0,devicePixelRatio,0,0);
    draw();
  }
  new ResizeObserver(resize).observe(canvas);

  let ball = { x: 140, y: 260, r: 8, vx:0, vy:0 };
  let aiming = false, aimFrom = {x:0,y:0}, aimTo = {x:0,y:0}, powerPct = 0;
  const powerLabel = document.getElementById("powerLabel");

  canvas.addEventListener("mousedown", (e)=>{
    if (state !== "playing" || me.id !== turnPlayerId) return;
    const rect = canvas.getBoundingClientRect();
    const x = e.clientX - rect.left, y = e.clientY - rect.top;
    const d = Math.hypot(x - ball.x, y - ball.y);
    if (d <= 18) {
      aiming = true; aimFrom = {x:ball.x, y:ball.y}; aimTo = {x,y};
    }
  });
  window.addEventListener("mousemove", (e)=>{
    if (!aiming) return;
    const rect = canvas.getBoundingClientRect();
    aimTo = { x: e.clientX - rect.left, y: e.clientY - rect.top };
    const v = { x: aimFrom.x - aimTo.x, y: aimFrom.y - aimTo.y };
    powerPct = Math.min(100, Math.round(Math.min(1, Math.hypot(v.x,v.y)/150)*100));
    powerLabel.textContent = `Power: ${powerPct}%`;
    draw();
  });
  window.addEventListener("mouseup", ()=>{
    if (!aiming) return;
    // compute shot vector, clamp power
    const v = { x: (aimFrom.x - aimTo.x), y: (aimFrom.y - aimTo.y) };
    const len = Math.hypot(v.x,v.y);
    if (len > 2) {
      const scale = Math.min(1, len/150); // power cap
      // convert to velocity-ish (server interprets)
      const speed = 12 * scale;
      const dirx = v.x / len, diry = v.y / len;
      sfx.hit(scale);
      socket.emit("shot:putt", { vx: dirx * speed, vy: diry * speed });
    }
    aiming = false; powerPct = 0; powerLabel.textContent = `Power: 0%`;
    draw();
  });

  function drawCourse(){
    if (!hole) return;
    // grass
    ctx.fillStyle = "#0d6b29"; ctx.fillRect(0,0,canvas.clientWidth, canvas.clientHeight);
    // fairway
    ctx.fillStyle = "#16a34a"; ctx.fillRect(80,120,680,280);
    // walls
    ctx.fillStyle = "#143255";
    hole.walls.forEach(([x,y,w,h])=> ctx.fillRect(x,y,w,h));
    // cup
    ctx.beginPath(); ctx.arc(hole.cup.x, hole.cup.y, hole.cup.r, 0, Math.PI*2);
    ctx.fillStyle = "#0b0f1a"; ctx.fill();
    ctx.beginPath(); ctx.arc(hole.cup.x, hole.cup.y, hole.cup.r-3, 0, Math.PI*2);
    ctx.fillStyle = "#222"; ctx.fill();
    // fun stripes
    ctx.globalAlpha = 0.15; ctx.fillStyle="#fff";
    for(let i=0;i<8;i++){ ctx.fillRect(90+i*80, 120, 40, 280); }
    ctx.globalAlpha = 1;
  }
  function drawBall(){
    // drop shadow
    ctx.beginPath(); ctx.arc(ball.x+2, ball.y+3, ball.r, 0, Math.PI*2);
    ctx.fillStyle="rgba(0,0,0,.35)"; ctx.fill();
    // ball
    ctx.beginPath(); ctx.arc(ball.x, ball.y, ball.r, 0, Math.PI*2);
    ctx.fillStyle="#fff"; ctx.fill(); ctx.strokeStyle="#cbd5e1"; ctx.lineWidth=1; ctx.stroke();
    // putter preview if it's my turn & aiming
    if (me.id === turnPlayerId && aiming){
      // power arrow
      const v = { x: aimFrom.x - aimTo.x, y: aimFrom.y - aimTo.y };
      ctx.strokeStyle = "#ffd166"; ctx.lineWidth = 3; ctx.lineCap="round";
      ctx.beginPath(); ctx.moveTo(ball.x, ball.y); ctx.lineTo(ball.x + v.x, ball.y + v.y); ctx.stroke();
    }
  }
  function drawHUD(){
    // nothing heavy yet
  }
  function draw(){
    drawCourse(); drawBall(); drawHUD();
  }

  // ----- SOCKET HANDLERS -----
  socket.on("room:joined", ({ roomId, playerId, hostId })=>{
    me.id = playerId; me.hostId = hostId;
    document.getElementById("holeInfo").textContent = "Hole ‚Äî / Par ‚Äî";
    inpName.value = `Golfer ${playerId.slice(0,4)}`;
  });

  socket.on("room:state", (p)=>{
    state = p.state; players = p.players; holeIndex = p.holeIndex;
    turnPlayerId = (p.players[p.turnIndex] || {}).id;
    // lobby UI
    playersEl.innerHTML = "";
    p.players.forEach(pl=>{
      const li = document.createElement("li");
      li.innerHTML = `${pl.avatar} <strong>${escape(pl.name)}</strong> ${pl.id===p.hostId?'<span class="chip">Host</span>':''} ${pl.ready?'<span class="chip ready">Ready</span>':''}`;
      playersEl.appendChild(li);
    });
    btnStart.style.display = (state==="lobby" && me.id===p.hostId) ? "" : "none";
    // turn label
    const turnName = (p.players.find(x=>x.id===turnPlayerId)||{}).name || "‚Äî";
    turnHeader.textContent = (state==="playing") ? `It's ${turnName}'s turn` : (state==="holeEnd"?"Hole Results":"Waiting‚Ä¶");
  });

  socket.on("chat:new", ({ name, avatar, text })=>{
    const div = document.createElement("div");
    div.innerHTML = `<span class="chip">${avatar}</span> <strong>${escape(name)}</strong>: ${escape(text)}`;
    chatEl.appendChild(div); chatEl.scrollTop = chatEl.scrollHeight;
  });

  socket.on("hole:start", ({ holeIndex: hi, hole: h })=>{
    hole = h; ball.x = h.start.x; ball.y = h.start.y; ball.vx=ball.vy=0;
    document.getElementById("holeInfo").textContent = `Hole ${hi+1} / Par ${h.par}`;
    draw();
    sfx.start(); musicStop(); musicStart();
  });

  socket.on("turn:begin", ({ playerId })=>{
    turnPlayerId = playerId;
    const p = players.find(x=>x.id===playerId);
    turnHeader.textContent = `It's ${p ? p.name : '‚Äî'}'s turn`;
    showToast(`${p ? p.name : 'Player'} to putt!`);
    sfx.turn();
  });

  socket.on("ball:update", ({ x,y,vx,vy })=>{
    ball.x = x; ball.y = y; ball.vx=vx; ball.vy=vy;
    draw();
  });

  socket.on("fx:bonk", ()=> sfx.bonk());
  socket.on("fx:cup", ()=> sfx.cup());
  socket.on("fx:limit", ()=> sfx.limit());

  socket.on("hole:end", ({ holeIndex: hi, par, results })=>{
    musicStop();
    // tiny scorecard (right panel)
    miniScore.innerHTML = "";
    (results||[]).sort((a,b)=>a.total-b.total).forEach(r=>{
      const row = document.createElement("div");
      row.className = "row";
      const name = (players.find(p=>p.id===r.id)||{}).name || r.name || r.id.slice(0,4);
      row.innerHTML = `<span ${r.id===me.id?'class="me"':''}>${escape(name)}</span><span>Hole: ${r.strokes || '-'} | Total: ${r.total}</span>`;
      miniScore.appendChild(row);
    });
    showToast(`Hole ${hi+1} done ‚Äî Par ${par}`);
  });

  socket.on("game:over", ({ leaderboard })=>{
    musicStop();
    showToast("Game Over! Thanks for playing ‚ù§Ô∏è");
  });

  // ----- UTILS -----
  function escape(s){ return (s+"").replace(/[&<>"']/g, m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;' }[m])); }
  function showToast(t){ toast.textContent=t; toast.style.display="block"; setTimeout(()=>toast.style.display="none", 1800); }

  // initial paint
  resize();
})();
</script>
</body>
</html>
